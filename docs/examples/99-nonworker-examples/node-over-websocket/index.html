<!DOCTYPE html>
<button id="trigger">Click me</button>
<pre id="output"></pre>
<script type="module">
  import * as Comlink from "/dist/esm/comlink.js";
  import { wrap } from "/dist/esm/string-channel.experimental.js";

  async function run() {
    console.log("Opening WebSocket connection...");
    const ws = new WebSocket(`ws://${location.host}/ws`);
    await new Promise(resolve =>
      ws.addEventListener("open", resolve, { once: true })
    );
    const api = Comlink.wrap(
      wrap({
        addMessageListener(f) {
          ws.addEventListener("message", ev => f(ev.data));
        },
        send(msg) {
          ws.send(msg);
        }
      })
    );
    document.querySelector("#trigger").addEventListener("click", async () => {
      await api.increase();
      document.querySelector(
        "#output"
      ).textContent = `Counter: ${await api.counter}`;
    });
  }
  run();
</script>
